<script>
window.addEventListener('load', async function() {
    let monedas = prompt("¿Cuántas monedas quieres tener al empezar?", "100");
    if (monedas !== null) monedas = Number(monedas);

    async function setUnityCoins(value) {
        return new Promise((resolve, reject) => {
            let request = indexedDB.open(window.location.origin + "_playerprefs");
            let dbInstance;

            // Crear object store si no existe
            request.onupgradeneeded = function(event) {
                let db = event.target.result;
                if (!db.objectStoreNames.contains("PlayerPrefs")) {
                    db.createObjectStore("PlayerPrefs");
                    console.log("[IndexedDB] Object store 'PlayerPrefs' creado.");
                }
            };

            request.onsuccess = function(event) {
                dbInstance = event.target.result;
                try {
                    let tx = dbInstance.transaction("PlayerPrefs", "readwrite");
                    let store = tx.objectStore("PlayerPrefs");
                    store.put({ coins: value }, "coins");
                    console.log("[IndexedDB] Monedas sobrescritas:", value);
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = (e) => reject(e);
                } catch (err) {
                    reject(err);
                }
            };

            request.onerror = function(e) {
                reject(e);
            };
        });
    }

    try {
        await setUnityCoins(monedas);
    } catch(e) {
        console.warn("[IndexedDB] Error al sobrescribir monedas:", e);
    }

    // Iniciar Unity
    window.gameInstance = UnityLoader.instantiate(
        "gameContainer",
        "Build/SnowRider3D-gd-1.json",
        {
            onProgress: UnityProgress,
            Module: {
                onRuntimeInitialized: function() {
                    UnityProgress(window.gameInstance, "complete");
                    console.log("[Unity] Juego cargado con monedas:", monedas);
                }
            }
        }
    );
});
</script>
